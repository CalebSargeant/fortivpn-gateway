name: Build Container Image

# This workflow:
# 1. Builds PR images on pull request events (tagged as pr-<number>)
# 2. When semantic-release creates a release, builds and tags with the release version
#
# Note: We rebuild on release instead of promoting because docker-bake produces
# multiple images (cookie, vpn, bgp) and the promote logic only handles single images.
# Rebuilding is fast due to layer caching.

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  pr_build:
    if: github.event_name == 'pull_request'
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway
      platforms: linux/amd64,linux/arm64
      push: true
    secrets: inherit

  release_build:
    if: github.event_name == 'release'
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway
      platforms: linux/amd64,linux/arm64
      push: true
    secrets: inherit
