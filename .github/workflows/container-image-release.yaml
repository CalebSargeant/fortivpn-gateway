name: Build Container Image on Release

# This workflow is triggered when semantic-release creates a new release
# It builds and pushes the Docker image with the release version tag

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]
  push:
    branches: [main]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  pr_build:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway
      platforms: linux/amd64,linux/arm64
      push: true
    secrets: inherit

  promote-cookie:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway-cookie
      platforms: linux/amd64,linux/arm64
      promote_pr_number: ${{ github.event.pull_request.number }}
      push: true
    secrets: inherit

  promote-vpn:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway-vpn
      platforms: linux/amd64,linux/arm64
      promote_pr_number: ${{ github.event.pull_request.number }}
      push: true
    secrets: inherit

  promote-bgp:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway-bgp
      platforms: linux/amd64,linux/arm64
      promote_pr_number: ${{ github.event.pull_request.number }}
      push: true
    secrets: inherit

  branch_build:
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, 'Merge pull request')
    uses: calebsargeant/reusable-workflows/.github/workflows/docker-bake-ghcr.yaml@v1.0.20
    with:
      image_name: fortivpn-gateway
      platforms: linux/amd64,linux/arm64
      push: true
    secrets: inherit
